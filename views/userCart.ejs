<%- include('userHeader') %>
  <div class="site-section  pb-0">
    <div class="container">
      <div class="row mb-5 justify-content-center">
        <div class="col-7 section-title text-center mb-5">
          <h2 class="d-block">Cart</h2>
        </div>
      </div>
      <div class="row mb-5">
        <form class="col-md-12" method="post">
          <div class="site-blocks-table">
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th class="product-thumbnail">Image</th>
                  <th class="product-name">Product</th>
                  <th class="product-price">Price</th>
                  <th class="product-quantity">Quantity</th>
                  <th class="product-total">Total</th>
                  <th class="product-remove">Remove</th>
                </tr>
              </thead>

              <tbody>
                <% cartItems.forEach(item=> { %>
                  <tr>
                    <td class="product-thumbnail">
                      <img src="<%= item.productId.image[0] %>" alt="Image" class="img-fluid">
                    </td>
                    <td class="product-name">
                      <h2 class="h5 cart-product-title text-black">
                        <%= item.productId.productName %>
                      </h2>
                    </td>
                    <td class="product-price">₹<%= item.productId.price %>
                    </td>


                    <td>
                      <div class="input-group mb-3" style="max-width: 120px;">
                        <div class="input-group-prepend">
                          <button class="btn btn-outline-primary js-btn-minus" type="button"
                            onclick="decrementQuantity('<%= item.productId._id %>')">&minus;</button>
                        </div>
                        <input type="text" class="form-control text-center border mr-0" value="<%= item.quantity %>"
                          data-product-id="<%= item.productId._id %>" placeholder="Example text with button addon"
                          aria-label="Example text with button addon" aria-describedby="button-addon1">
                        <div class="input-group-append">
                          <button class="btn btn-outline-primary js-btn-plus" type="button"
                            onclick="incrementQuantity('<%= item.productId.totalQuantity %>', '<%= item.productId._id %>')">&plus;</button>
                        </div>
                      </div>

                    </td>



                    <td class="total-productPrice" data-product-id="<%= item.productId._id %>">₹<%= item.productId.price
                        * item.quantity %>
                    </td>
                    <td><a href="/removeFromCart/<%= item.productId._id %>"
                        class="btn btn-primary height-auto btn-sm">Remove</a></td>
                  </tr>
                  <% }) %>
              </tbody>
            </table>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="site-section pt-5 bg-light">
    <div class="container">
      <div class="row">
        <div class="col-md-6">
          <div class="row mb-5">

            <div class="col-md-6">
              <a href="/userShop" class="btn btn-outline-primary btn-md btn-block">Continue Shopping</a>
            </div>
          </div>
          <div class="row">
            <div class="col-md-12">
              <label class="text-black h4" for="coupon">Coupon</label>
              <p>Enter your coupon code if you have one.</p>
            </div>
            <div class="col-md-8 mb-3 mb-md-0">
              <input type="text" class="form-control py-3" id="coupon" placeholder="Coupon Code">
            </div>
            <div class="col-md-4">
              <button class="btn btn-primary btn-md px-4" onclick="applyCoupon()">Apply Coupon</button>
            </div>
          </div>
        </div>
        <div class="col-md-6 pl-5">
          <div class="row justify-content-end">
            <div class="col-md-7">
              <div class="row">
                <div class="col-md-12 text-right border-bottom mb-5">
                  <h3 class="text-black h4 text-uppercase">Cart Totals</h3>
                </div>
              </div>

              <div class="row mb-5">
                <div class="col-md-6">
                  <span class="text-black">Total</span>
                </div>
                <div class="col-md-6 text-right">
                  <strong class="totalPrice text-black">₹<%=totalPrice?totalPrice:0%></strong>
                </div>
              </div>
              <div class="row">
                <div class="col-md-12">
                  <% if(cartItems.length!=0) {%>
                    <a href="/userCheckout" class="btn btn-primary btn-lg btn-block"
                      onclick="window.location='checkout.html'">Proceed
                      To
                      Checkout</a>
                    <%}%>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="footer">
    <div class="container">
      <div class="row">
        <div class="col-12 text-center">
          <div class="social-icons">
            <a href="#"><span class="icon-facebook"></span></a>
            <a href="#"><span class="icon-twitter"></span></a>
            <a href="#"><span class="icon-youtube"></span></a>
            <a href="#"><span class="icon-instagram"></span></a>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-12">
          <div class="copyright">
            <p>

              Copyright 2024 &copy;
              <script>document.write(new Date().getFullYear());</script> All rights reserved | This template is Designed
              <i class="icon-heart text-danger" aria-hidden="true"></i> <a href="https://colorlib.com"
                target="_blank">by Paul Boby T</a>

            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>


  <div id="loader" class="show fullscreen"><svg class="circular" width="48px" height="48px">
      <circle class="path-bg" cx="24" cy="24" r="22" fill="none" stroke-width="4" stroke="#eeeeee" />
      <circle class="path" cx="24" cy="24" r="22" fill="none" stroke-width="4" stroke-miterlimit="10"
        stroke="#ff5e15" />
    </svg></div>
  <script src="js/jquery-3.3.1.min.js"></script>
  <script src="js/jquery-migrate-3.0.1.min.js"></script>
  <script src="js/jquery-ui.js"></script>
  <script src="js/popper.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/owl.carousel.min.js"></script>
  <script src="js/jquery.stellar.min.js"></script>
  <script src="js/jquery.countdown.min.js"></script>
  <script src="js/bootstrap-datepicker.min.js"></script>
  <script src="js/jquery.easing.1.3.js"></script>
  <script src="js/aos.js"></script>
  <script src="js/jquery.fancybox.min.js"></script>
  <script src="js/jquery.sticky.js"></script>
  <script src="js/jquery.mb.YTPlayer.min.js"></script>
  <script src="js/main.js"></script>

  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-23581568-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'UA-23581568-13');
  </script>
  <script defer src="https://static.cloudflareinsights.com/beacon.min.js/v84a3a4012de94ce1a686ba8c167c359c1696973893317"
    integrity="sha512-euoFGowhlaLqXsPWQ48qSkBSCFs3DPRyiwVu3FjR96cMPx+Fr+gpWRhIafcHwqwCqWS42RZhIudOvEI+Ckf6MA=="
    data-cf-beacon='{"rayId":"831baebb1b39a3da","b":1,"version":"2023.10.0","token":"cd0b4b3a733644fc843ef0b185f98241"}'
    crossorigin="anonymous"></script>


  <script>







    $(document).ready(function () {


      function updateQuantity(productId, newQuantity) {
        $.ajax({
          type: "POST",
          url: `/updateQuantity/${productId}`,
          data: { quantity: newQuantity },
          success: function (response) {


            const input = $(`input[data-product-id="${productId}"]`);
            input.val(newQuantity);

            const total = newQuantity * response.updatedProduct.price;
            console.log("newQuantity", newQuantity)
            console.log("response.price", response.updatedProduct.price)
            console.log("response.cartItems", response.updatedProduct.cartItems);
            $(`td.total-productPrice[data-product-id="${productId}"]`).text(`$${total.toFixed(2)}`);


            updateCartTotals(response.updatedProduct.cartItems);


          },
          error: function (error) {
            console.error("Error updating quantity:", error);
          },
        });
      }

      $(".js-btn-plus").on("click", function () {
        const input = $(this).closest(".input-group").find("input");
        const productId = input.data("product-id");
        const newQuantity = parseInt(input.val()) + 1;
        updateQuantity(productId, newQuantity);
        if (newQuantity <= 5) {
          updateQuantity(productId, newQuantity);
        }
        else {
          console.log("Quantity cannot be updated, new quantity is greater than 5.");
        }
      });


      $(".js-btn-minus").on("click", function () {
        const input = $(this).closest(".input-group").find("input");
        const productId = input.data("product-id");
        const newQuantity = parseInt(input.val()) - 1;
        // Ensure quantity does not go below 1
        if (newQuantity >= 1) {
          updateQuantity(productId, newQuantity);
        }
      });




      function updateCartTotals(cartItems) {
        let subtotal = 0;


        cartItems.forEach(item => {
          const total = item.quantity * item.productId.price;
          subtotal += total;
        });
        console.log(subtotal)


        $(".totalPrice").text(`$${subtotal.toFixed(2)}`);
      }
    });





    function incrementQuantity(currentQuantity, productId) {
      console.log("Current Quantity:", currentQuantity);
      console.log("Product ID:", productId);
      const maxQuantity = 5; // Maximum allowed quantity
      const input = $('input[data-product-id="' + productId + '"]');
      const newQuantity = parseInt(input.val()) + 1;

      const stockQuantity = currentQuantity; 
      if (newQuantity <= maxQuantity && newQuantity <= stockQuantity) {
       
        updateQuantity(productId, newQuantity);

        
        if (newQuantity === stockQuantity) {
          input.closest(".input-group").find(".js-btn-plus").prop("disabled", true);
        }
      } else if (newQuantity > maxQuantity) {
        alert("The maximum quantity for this product is " + maxQuantity + ".");
      } else if (newQuantity > stockQuantity) {
     
        alert("There is not enough stock for this product.");
        input.closest(".input-group").find(".js-btn-plus").prop("disabled", true); 
        return; 
      }
    }


  </script>



  <script>
    $(document).ready(function () {
      // Minus button click
      $('.js-btn-minus').on('click', function () {
        var input = $(this).closest('.input-group').find('input');
        var value = parseInt(input.val());

        if (value > 1) {
          input.val(value - 1);
        }

        // Disable minus button if the quantity is 1
        updateMinusButtonState(input);
      });

      // Plus button click
      $('.js-btn-plus').on('click', function () {
        var input = $(this).closest('.input-group').find('input');
        var value = parseInt(input.val());
        if (value > 5) {
          alert('you can Only add upto  5')
        } else { input.val(value + 1); }



        
        updateMinusButtonState(input);
      });

     
      function updateMinusButtonState(input) {
        var value = parseInt(input.val());
        var minusButton = input.closest('.input-group').find('.js-btn-minus');

        if (value === 1) {
         
          minusButton.prop('disabled', true);
        } else {
       
          minusButton.prop('disabled', false);
        }
      }

    
      $('.input-group').each(function () {
        var input = $(this).find('input');
        updateMinusButtonState(input);
      });
    });
  </script>
  <script>
    function applyCoupon() {
      const couponCode = document.getElementById('coupons').value;
      
      fetch('/applyCoupon', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ couponCode })
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            
            document.querySelector('.totalPrice').innerText = `₹${data.totalPrice}`;
            
            alert('Coupon applied successfully!');
          } else {
            alert('Failed to apply coupon. Please check the coupon code.');
          }
        })
        .catch(error => {
          console.error('Error applying coupon:', error);
          alert('An error occurred while applying the coupon. Please try again later.');
        });
    }

  </script>



  </body>

  </html>